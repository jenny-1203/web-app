<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»é¤ App</title>
    <!-- PWA Meta Tags for App-like Experience -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">

    <link rel="manifest" id="manifest">
    <style>
        /* Manually creating manifest and using internal data URL for icon for self-contained file */
        @font-face {
            font-family: 'Inter';
            src: url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        }
        body { font-family: 'Inter', sans-serif; }
    </style>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons (for better App-like icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Main Application Container -->
    <div id="app" class="relative max-w-4xl mx-auto min-h-screen flex flex-col">

        <!-- Header -->
        <header id="header" class="sticky top-0 z-20 bg-blue-600 shadow-lg text-white p-4 flex items-center justify-between transition-all duration-300">
            <h1 class="text-xl font-bold tracking-tight">é»é¤ç³»çµ±</h1>
            <div class="flex items-center space-x-2">
                <button id="modeToggleBtn" class="bg-blue-800 hover:bg-blue-700 text-xs font-semibold py-1 px-2 rounded-full shadow-md transition-colors duration-200 flex items-center">
                    <i class="ph ph-wrench text-base mr-1"></i> <span id="modeText">åˆ‡æ›è‡³ç®¡ç†å“¡æ¨¡å¼</span>
                </button>
                <i id="userStatusIcon" class="ph ph-user text-2xl text-white ml-2" title="ä½¿ç”¨è€… ID"></i>
            </div>
        </header>

        <!-- Group Order Header (Visible only in Group Mode) -->
        <div id="groupHeader" class="sticky top-[72px] z-10 bg-indigo-100 text-indigo-800 p-3 shadow-md border-b border-indigo-200 hidden flex-col sm:flex-row items-center justify-between gap-2 transition-all duration-300">
            <div class="flex items-center">
                 <i class="ph ph-users-three text-xl mr-2"></i>
                <span class="font-semibold text-sm">åœ˜è³¼ä¸­! ç•¶å‰åº—å®¶ï¼š<span id="groupShopName" class="text-indigo-900 font-extrabold"></span></span>
            </div>
            <button id="copyGroupLinkBtn" class="flex items-center bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-medium py-1 px-3 rounded-lg shadow-lg transition-colors duration-200">
                <i class="ph ph-share-network text-base mr-1"></i> åˆ†äº«æ­¤åœ˜è³¼é€£çµ
            </button>
        </div>


        <!-- Main Content Area -->
        <main class="flex-grow p-4 pb-20 sm:pb-4 transition-all duration-300">

            <!-- Admin View Section -->
            <section id="adminView" class="hidden space-y-8 bg-white p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4 flex items-center">
                    <i class="ph ph-gear-six text-2xl mr-2"></i> ç³»çµ±ç®¡ç†å¾Œå°
                </h2>

                <!-- Shop Management -->
                <div class="space-y-4 border p-4 rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold text-gray-700 flex items-center">
                        <i class="ph ph-storefront text-xl mr-2 text-blue-600"></i> åº—å®¶ç®¡ç†
                    </h3>
                    <button id="addNewShopBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg shadow-md transition-colors duration-200 flex items-center justify-center">
                        <i class="ph ph-plus-circle text-lg mr-2"></i> æ–°å¢åº—å®¶
                    </button>
                    <div id="shopListContainer" class="space-y-3">
                        <!-- Shop list will be inserted here -->
                        <p class="text-center text-gray-500" id="noShopsMessage">ç›®å‰æ²’æœ‰åº—å®¶</p>
                    </div>
                </div>

                <!-- Menu Management (Visible only if a shop is selected/managed) -->
                <div id="shopMenuManagement" class="space-y-4 border-t pt-4 hidden">
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="ph ph-list text-2xl mr-2"></i> <span id="currentAdminShopName"></span> èœå–®ç®¡ç†
                    </h3>

                    <!-- AI Menu Generator -->
                    <div class="space-y-4 border p-4 rounded-lg bg-yellow-50">
                        <h3 class="text-xl font-semibold text-gray-700 flex items-center">
                            <i class="ph ph-robot text-xl mr-2 text-yellow-600"></i> ğŸ¤– AI èœå–®ç”Ÿæˆå™¨
                        </h3>
                        <p class="text-sm text-gray-600">è²¼ä¸Šæ‚¨çš„èœå–®æ–‡æœ¬ï¼ˆåç¨± åƒ¹æ ¼ æè¿°ï¼‰ï¼ŒAI æœƒè‡ªå‹•çµæ§‹åŒ–ã€‚</p>
                        <textarea id="menuInput" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition-shadow duration-200" placeholder="ç¯„ä¾‹ï¼šæ‹›ç‰Œç‰›è‚‰éºµ $180 å¥½åƒåˆå¤§ç¢—"></textarea>
                        <button id="generateMenuBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-xl shadow-lg transition-colors duration-200 flex items-center justify-center">
                            <i class="ph ph-magic-wand text-lg mr-2"></i> ç”Ÿæˆä¸¦é è¦½èœå–®é …ç›®
                        </button>
                        <div id="aiLoading" class="text-center text-blue-500 font-medium hidden">
                            <i class="ph ph-spinner animate-spin text-2xl"></i> AI æ­£åœ¨è§£æèœå–®ä¸­...
                        </div>
                    </div>

                    <!-- AI Generated Menu Preview -->
                    <div id="aiPreviewContainer" class="hidden space-y-4 border-t pt-4">
                        <h3 class="text-xl font-semibold text-gray-800">AI å»ºè­°èœå–® (å¾…ç¢ºèª)</h3>
                        <div id="aiPreviewList" class="space-y-3">
                            <!-- AI generated items will be inserted here -->
                        </div>
                        <button id="saveAllAIToMenuBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl shadow-lg transition-colors duration-200 mt-4">
                            âœ… å„²å­˜å…¨éƒ¨ AI é …ç›®åˆ°èœå–®
                        </button>
                    </div>

                    <!-- Manual Menu Management -->
                    <div class="space-y-4 border-t pt-4">
                        <h3 class="text-xl font-semibold text-gray-800">æ‰‹å‹•èœå–®ç®¡ç†</h3>
                        <button id="addNewItemBtn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 rounded-lg shadow-md transition-colors duration-200 flex items-center justify-center">
                            <i class="ph ph-plus-circle text-lg mr-2"></i> æ–°å¢èœå–®é …ç›®
                        </button>
                        <div id="menuItemsContainer" class="space-y-4">
                            <!-- Menu items for admin editing will be inserted here -->
                            <p class="text-center text-gray-500" id="noMenuItemsMessage">æ­¤åº—å®¶ç›®å‰æ²’æœ‰èœå–®é …ç›®</p>
                        </div>
                    </div>
                </div>

            </section>

            <!-- Customer View Section -->
            <section id="customerView" class="space-y-6">

                <!-- Shop Selector (Switching Menus) -->
                <div class="bg-white p-3 rounded-xl shadow-lg flex flex-col sm:flex-row items-start sm:items-center mb-6">
                    <label for="shopSelector" class="font-semibold text-gray-700 mr-3 mb-2 sm:mb-0 whitespace-nowrap flex items-center">
                        <i class="ph ph-storefront text-xl mr-2 text-blue-600"></i> é¸æ“‡åº—å®¶èœå–®:
                    </label>
                    <select id="shopSelector" class="flex-grow w-full sm:w-auto p-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 transition-shadow duration-200"></select>
                </div>

                <!-- Menu Display -->
                <div id="menuList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Menu items will be inserted here -->
                </div>
                <p id="loadingMenuMessage" class="text-center text-gray-500 font-medium hidden">
                    <i class="ph ph-spinner animate-spin text-2xl"></i> æ­£åœ¨è¼‰å…¥èœå–®...
                </p>
                <p id="emptyMenuMessage" class="text-center text-gray-500 font-medium hidden">
                    æ­¤åº—å®¶ç›®å‰æ²’æœ‰èœå–®é …ç›®ã€‚è«‹è¯ç¹«ç®¡ç†å“¡ä¸Šå‚³èœå–®ã€‚
                </p>


                <!-- Order History (Simple display for the current user) -->
                <div id="orderHistoryContainer" class="pt-4 border-t mt-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="ph ph-clock-counter-clockwise text-2xl mr-2"></i> æˆ‘çš„è¨‚å–®
                    </h2>
                    <div id="orderHistoryList" class="space-y-3">
                        <!-- User's order history will be inserted here -->
                        <p class="text-gray-500 text-center" id="noOrdersMessage">æ‚¨ç›®å‰æ²’æœ‰è¨‚å–®ã€‚</p>
                    </div>
                </div>

            </section>
        </main>

        <!-- Mobile Floating Cart Button (Footer) -->
        <div id="mobileCartFloat" class="fixed bottom-0 left-0 right-0 z-30 p-3 sm:hidden bg-white/90 backdrop-blur-sm border-t shadow-2xl">
            <button id="openCartBtnMobile" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-xl flex justify-between items-center transition-colors duration-200">
                <span class="flex items-center">
                    <i class="ph ph-shopping-cart-simple text-2xl mr-2"></i>
                    æŸ¥çœ‹è¨‚å–® (<span id="mobileItemCount">0</span>)
                </span>
                <span id="mobileTotalPrice" class="text-lg font-extrabold">NT$ 0</span>
            </button>

            <!-- Group Order Button (Visible in Customer View) -->
            <button id="startGroupOrderBtn" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-xl shadow-md transition-colors duration-200 flex items-center justify-center">
                <i class="ph ph-users-three text-lg mr-2"></i> ç™¼èµ·åœ˜è³¼
            </button>
        </div>


        <!-- Cart/Order Modal (Slide-up Panel for Mobile) -->
        <div id="cartModal" class="fixed inset-0 z-40 hidden bg-black/50 transition-opacity duration-300" onclick="hideCartModal()">
            <div id="cartPanel" class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl p-6 transform translate-y-full transition-transform duration-300 sm:max-w-xl sm:mx-auto sm:rounded-b-none sm:top-0 sm:bottom-0 sm:translate-y-0 sm:right-0 sm:left-auto" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center pb-4 border-b">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="ph ph-receipt text-2xl mr-2"></i> æ‚¨çš„è¨‚å–®
                    </h2>
                    <button onclick="hideCartModal()" class="text-gray-500 hover:text-gray-700 transition-colors duration-200">
                        <i class="ph ph-x-circle text-3xl"></i>
                    </button>
                </div>

                <div id="cartItemsList" class="max-h-[60vh] overflow-y-auto py-4 space-y-4">
                    <!-- Cart items will be inserted here -->
                    <p id="emptyCartMessage" class="text-center text-gray-500 mt-4">è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œå¿«å»é»é¤å§ï¼</p>
                </div>

                <div class="pt-4 border-t mt-4">
                    <div id="groupParticipants" class="mb-4 space-y-2 hidden">
                        <p class="font-semibold text-sm text-indigo-700 flex items-center"><i class="ph ph-users-three mr-2"></i> åœ˜è³¼åƒèˆ‡è€…ï¼š</p>
                        <div id="participantList" class="flex flex-wrap gap-2 text-xs">
                            <!-- Participants will be listed here -->
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-xl font-bold mb-4">
                        <span>ç¸½é‡‘é¡ï¼š</span>
                        <span id="finalTotalPrice" class="text-blue-600">NT$ 0</span>
                    </div>

                    <!-- Checkout Button -->
                    <button id="checkoutBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-2xl transition-colors duration-200">
                        ä¸‹è¨‚å–®
                    </button>
                </div>
            </div>
        </div>

        <!-- Generic Modal for Messages and Prompts -->
        <div id="genericModal" class="fixed inset-0 z-50 hidden bg-black/60 items-center justify-center p-4 transition-opacity duration-300">
            <div id="modalContent" class="bg-white p-6 rounded-2xl shadow-3xl max-w-sm w-full space-y-4 transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800">è¨Šæ¯</h3>
                <p id="modalBody" class="text-gray-600"></p>
                <input id="modalInput" type="text" class="hidden w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <div class="flex justify-end space-x-3">
                    <button id="modalCancelBtn" class="hidden px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors duration-200">å–æ¶ˆ</button>
                    <button id="modalConfirmBtn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors duration-200">ç¢ºå®š</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot,
            collection, query, where, getDocs, runTransaction, arrayUnion, onLog
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and App variables
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default ID
        let currentGroupOrderId = null; // Tracks the current group order ID
        let isGroupOrderCreator = false; // Is the current user the creator of the group order
        let isAuthReady = false;

        // --- Core App State ---
        let cart = []; // { itemId, quantity, name, price, userId }
        let menuItems = []; // Full list of menu items from the currently selected shop
        let shops = []; // List of all available shops: { id, name }
        let currentShopId = null; // Currently selected shop ID
        let menuUnsubscribe = null; // Listener cleanup for current menu
        let isCustomerMode = true; // True for Customer, False for Admin
        let aiGeneratedItems = []; // Storage for items parsed by AI before confirmation
        let currentAdminShopId = null; // Shop ID being edited in Admin view

        // --- Configuration ---
        const ADMIN_KEY = 'admin123';

        // =========================================================================
        // !!! å·²æ•´åˆæ‚¨çš„ Firebase é…ç½®è³‡è¨Š !!!
        // =========================================================================

        // 1. è¨­å®šä¸€å€‹å›ºå®šä¸”å”¯ä¸€çš„æ‡‰ç”¨ç¨‹å¼ ID (ä½¿ç”¨ Project ID)
        const APP_ID = 'order-app-78120';

        // 2. è²¼ä¸Šæ‚¨å¾ Firebase Console è¤‡è£½çš„é…ç½® JSON ç‰©ä»¶
        const firebaseConfig = {
            apiKey: "AIzaSyDRLuIf3PNueBmvKCdASDeU0OgSuqvVI4s",
            authDomain: "order-app-78120.firebaseapp.com",
            projectId: "order-app-78120",
            storageBucket: "order-app-78120.firebasestorage.app",
            messagingSenderId: "808140941952",
            appId: "1:808140941952:web:4cbca1137338b6899d5465",
            measurementId: "G-EQ20QLNR5G"
        };
        const INITIAL_AUTH_TOKEN = null; // ä¿æŒç‚º null (ç”¨æ–¼ Vercel éƒ¨ç½²)

        // =========================================================================

        const SHOPS_COLLECTION_PATH = `/artifacts/${APP_ID}/public/data/shops`;
        const ORDERS_COLLECTION_PATH = `/artifacts/${APP_ID}/public/data/orders`;
        const GROUP_ORDERS_COLLECTION_PATH = `/artifacts/${APP_ID}/public/data/groupOrders`;

        // Get the group order button element
        const startGroupOrderBtn = document.getElementById('startGroupOrderBtn');
        const shopSelector = document.getElementById('shopSelector');

        // --- Utility Functions ---

        /**
         * @param {string} title
         * @param {string} body
         * @param {string} confirmText
         * @param {string} cancelText
         * @param {string} inputType 'text', 'password' or null
         * @param {string} defaultValue Default value for input
         * @returns {Promise<string|boolean>} The input value or true/false for confirmation.
         */
        function showModal(title, body, confirmText = 'ç¢ºå®š', cancelText = null, inputType = null, defaultValue = '') {
            return new Promise(resolve => {
                const modal = document.getElementById('genericModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');
                const modalInput = document.getElementById('modalInput');
                const confirmBtn = document.getElementById('modalConfirmBtn');
                const cancelBtn = document.getElementById('modalCancelBtn');

                modalTitle.textContent = title;
                modalBody.textContent = body;

                modalInput.value = defaultValue;
                if (inputType === 'text') {
                    modalInput.type = 'text';
                    modalInput.classList.remove('hidden');
                } else if (inputType === 'password') {
                    modalInput.type = 'password';
                    modalInput.classList.remove('hidden');
                }
                 else {
                    modalInput.classList.add('hidden');
                }

                confirmBtn.textContent = confirmText;

                const cleanup = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                };

                confirmBtn.onclick = () => {
                    cleanup();
                    resolve(inputType ? modalInput.value : true);
                };

                if (cancelText) {
                    cancelBtn.textContent = cancelText;
                    cancelBtn.classList.remove('hidden');
                    cancelBtn.onclick = () => {
                        cleanup();
                        resolve(false);
                    };
                } else {
                    cancelBtn.classList.add('hidden');
                }

                modal.classList.remove('hidden');
                modal.classList.add('flex');
            });
        }

        // --- PWA Manifest and Initialization ---

        function createManifest() {
            const manifestData = {
                name: "é»é¤App",
                short_name: "é»é¤",
                description: "æ‰‹æ©Ÿå„ªåŒ–çš„ PWA é»é¤æ‡‰ç”¨ç¨‹å¼ã€‚",
                start_url: ".",
                display: "standalone",
                background_color: "#ffffff",
                theme_color: "#3b82f6",
                icons: [
                    {
                        src: "https://placehold.co/192x192/3b82f6/ffffff?text=Order",
                        sizes: "192x192",
                        type: "image/png"
                    },
                    {
                        src: "https://placehold.co/512x512/3b82f6/ffffff?text=Order",
                        sizes: "512x512",
                        type: "image/png"
                    }
                ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            document.getElementById('manifest').setAttribute('href', manifestUrl);
        }

        // --- Firebase & Auth Setup ---

        async function firebaseInit() {
            try {
                if (firebaseConfig && Object.keys(firebaseConfig).length > 0 && firebaseConfig.projectId) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                } else {
                    console.error("Firebase configuration is missing or invalid.");
                    if (typeof __firebase_config === 'undefined') {
                         await showModal('éŒ¯èª¤', 'Firebase é…ç½®éºå¤±ï¼Œè³‡æ–™åº«åŠŸèƒ½å°‡ç„¡æ³•ä½¿ç”¨ã€‚è«‹æ‰‹å‹•ç·¨è¼¯ index.html æª”æ¡ˆï¼Œå¡«å…¥æ‚¨çš„ Firebase é…ç½®è³‡è¨Šã€‚');
                    }
                    return;
                }

                // Authentication listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userStatusIcon').title = `å·²ç™»å…¥: ${userId}`;
                        document.getElementById('userStatusIcon').classList.remove('ph-user');
                        document.getElementById('userStatusIcon').classList.add('ph-user-circle-fill');
                    } else {
                        // Attempt anonymous sign-in if no user is found
                        await signInAnonymously(auth);
                    }
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    startDataListeners();
                    // Initial rendering is handled by the data listeners now
                    handleUrlHash();
                });

                // Use custom token if provided (Canvas environment)
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // Start anonymous sign-in if no token is available
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                await showModal('éŒ¯èª¤', `Firebase å•Ÿå‹•å¤±æ•—: ${error.message}`);
            }
        }

        // --- Routing and State Management ---

        function handleUrlHash() {
            if (!isAuthReady || !db) return;

            const hash = window.location.hash.substring(1);
            const match = hash.match(/^group\/([a-zA-Z0-9]+)$/);

            if (match) {
                const groupId = match[1];
                enterGroupOrder(groupId);
            } else {
                exitGroupOrder();
                if (!isCustomerMode) {
                    setMode('admin');
                } else {
                    setMode('customer');
                }
            }
        }

        window.addEventListener('hashchange', handleUrlHash);

        function setMode(mode) {
            if (mode === 'admin') {
                isCustomerMode = false;
                document.getElementById('adminView').classList.remove('hidden');
                document.getElementById('customerView').classList.add('hidden');
                document.getElementById('modeText').textContent = 'åˆ‡æ›è‡³é»é¤æ¨¡å¼';
                document.getElementById('header').classList.remove('bg-blue-600');
                document.getElementById('header').classList.add('bg-gray-800');
                document.getElementById('mobileCartFloat').classList.add('hidden');
                document.getElementById('groupHeader').classList.add('hidden');
            } else { // customer mode
                isCustomerMode = true;
                document.getElementById('adminView').classList.add('hidden');
                document.getElementById('customerView').classList.remove('hidden');
                document.getElementById('modeText').textContent = 'åˆ‡æ›è‡³ç®¡ç†å“¡æ¨¡å¼';
                document.getElementById('header').classList.remove('bg-gray-800');
                document.getElementById('header').classList.add('bg-blue-600');

                // Only show floating cart if not in group order (mobile only)
                if (!currentGroupOrderId && window.innerWidth < 640) {
                    document.getElementById('mobileCartFloat').classList.remove('hidden');
                }

                // Show/Hide group header based on group status
                if (currentGroupOrderId) {
                    document.getElementById('groupHeader').classList.remove('hidden');
                    startGroupOrderBtn.classList.add('hidden');
                    shopSelector.disabled = true; // Disable shop switching during group order
                } else {
                    document.getElementById('groupHeader').classList.add('hidden');
                    startGroupOrderBtn.classList.remove('hidden');
                    shopSelector.disabled = false;
                }
            }
            renderUI();
        }

        // --- Data Listeners (Firestore) ---

        function startDataListeners() {
            if (!db || !isAuthReady) return;

            // 1. Shops Listener (Public)
            onSnapshot(collection(db, SHOPS_COLLECTION_PATH), (snapshot) => {
                const fetchedShops = [];
                snapshot.forEach(doc => {
                    fetchedShops.push({ id: doc.id, ...doc.data() });
                });
                shops = fetchedShops.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));

                if (shops.length === 0 && !isCustomerMode) {
                    initializeDemoShop(); // Create a default shop if none exists
                }

                renderShopSelector(); // Update the dropdown with new shops

                // If currentShopId is not set or the selected shop was deleted, set a new default
                if (!currentShopId || !shops.some(s => s.id === currentShopId)) {
                    currentShopId = shops.length > 0 ? shops[0].id : null;
                    // Trigger menu update for the new default shop
                    if (!currentGroupOrderId) {
                        updateMenuListener(currentShopId);
                    }
                } else if (!currentGroupOrderId) {
                    // Re-render UI to reflect shop changes (e.g., name updates)
                    renderUI();
                }

            }, (error) => {
                console.error("Error listening to shops:", error);
            });


            // 2. User Order History Listener (Private)
            onSnapshot(query(collection(db, ORDERS_COLLECTION_PATH), where("userId", "==", userId)), (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                renderOrderHistory(orders.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate()));
            }, (error) => {
                console.error("Error listening to order history:", error);
            });

            // 3. Group Order Listener (Only if in group mode - handled by handleUrlHash)
        }

        function updateMenuListener(shopId) {
            // Cleanup previous listener if it exists
            if (menuUnsubscribe) {
                menuUnsubscribe();
                menuItems = [];
                renderMenuList(); // Clear the old menu display immediately
            }

            if (!shopId) {
                menuItems = [];
                renderMenuList();
                document.getElementById('loadingMenuMessage').classList.add('hidden');
                document.getElementById('emptyMenuMessage').classList.remove('hidden');
                return;
            }

            document.getElementById('loadingMenuMessage').classList.remove('hidden');
            document.getElementById('emptyMenuMessage').classList.add('hidden');

            const menuCollectionPath = `${SHOPS_COLLECTION_PATH}/${shopId}/menu`;
            menuUnsubscribe = onSnapshot(collection(db, menuCollectionPath), (snapshot) => {
                const items = [];
                snapshot.forEach(doc => {
                    items.push({ id: doc.id, ...doc.data() });
                });
                menuItems = items;
                document.getElementById('loadingMenuMessage').classList.add('hidden');

                // If menu is empty, show message and prompt admin to initialize
                if (menuItems.length === 0) {
                    if (isCustomerMode) {
                        document.getElementById('emptyMenuMessage').classList.remove('hidden');
                    } else {
                        // Admin mode, keep the view functional
                    }
                } else {
                    document.getElementById('emptyMenuMessage').classList.add('hidden');
                }

                renderUI(); // Render the menu list
            }, (error) => {
                console.error("Error listening to menu:", error);
            });
        }

        // --- Shop Management (Admin/Demo) ---

        async function initializeDemoShop() {
            console.log("Initializing demo shop...");
            const defaultShop = { name: "ç¾é£Ÿå°åƒåº—", createdAt: new Date() };

            try {
                // 1. Create default shop
                const shopDocRef = await addDoc(collection(db, SHOPS_COLLECTION_PATH), defaultShop);

                // 2. Create demo menu items in the shop's subcollection
                const demoItems = [
                    { name: "æ‹›ç‰Œç‰›è‚‰éºµ", price: 180, category: "ä¸»é£Ÿ", description: "å¤šæ±ç‰›è‚‰èˆ‡æ–°é®®è”¬èœ", imageUrl: "https://placehold.co/150x150/7dd3fc/0f172a?text=ç‰›è‚‰éºµ" },
                    { name: "é¦™è„†ç‚¸é›æ’", price: 80, category: "å°é»", description: "é‡‘é»ƒé…¥è„†ï¼Œä¸€å£æ¥ä¸€å£", imageUrl: "https://placehold.co/150x150/fde047/78350f?text=é›æ’" },
                    { name: "ç¶“å…¸çç å¥¶èŒ¶", price: 75, category: "é£²æ–™", description: "æ¿ƒéƒå¥¶èŒ¶ï¼ŒQå½ˆçç ", imageUrl: "https://placehold.co/150x150/f0abfc/4a044e?text=çå¥¶" },
                ];

                const batch = [];
                demoItems.forEach(item => {
                    const docRef = doc(collection(db, `${SHOPS_COLLECTION_PATH}/${shopDocRef.id}/menu`));
                    batch.push(setDoc(docRef, { ...item, createdAt: new Date() }));
                });

                await Promise.all(batch);
                console.log("Demo shop and menu initialized.");
            } catch (e) {
                console.error("Error setting demo shop/menu:", e);
                await showModal('éŒ¯èª¤', 'ç„¡æ³•å¯«å…¥æ¨¡æ“¬åº—å®¶èˆ‡èœå–®ã€‚');
            }
        }

        // --- Shop Selector Handler ---
        shopSelector.addEventListener('change', (e) => {
            const newShopId = e.target.value;
            if (newShopId !== currentShopId) {
                currentShopId = newShopId;
                updateMenuListener(currentShopId);
            }
        });

        // --- Shopping Cart Logic ---
        // ... (addToCart, removeFromCart, calculateCartTotals, updateLocalCart remain the same) ...

        function addToCart(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            const existingCartItem = cart.find(c => c.itemId === itemId && c.userId === userId);

            if (currentGroupOrderId) {
                // Group order: modify item count in the group order document
                updateGroupOrderItem(itemId, 1, item);
            } else {
                // Personal order: modify local cart
                if (existingCartItem) {
                    existingCartItem.quantity += 1;
                } else {
                    // Include shopId in the cart item for checkout history tracking
                    cart.push({ itemId: item.id, quantity: 1, name: item.name, price: item.price, userId: userId, shopId: currentShopId, shopName: shops.find(s => s.id === currentShopId)?.name || 'æœªçŸ¥åº—å®¶' });
                }
                updateLocalCart();
            }
        }

        function removeFromCart(itemId) {
            const existingCartItem = cart.find(c => c.itemId === itemId && c.userId === userId);
            if (!existingCartItem) return;

            if (currentGroupOrderId) {
                // Group order: modify item count in the group order document
                updateGroupOrderItem(itemId, -1);
            } else {
                // Personal order: modify local cart
                existingCartItem.quantity -= 1;
                if (existingCartItem.quantity <= 0) {
                    cart = cart.filter(c => c.itemId !== itemId || c.userId !== userId);
                }
                updateLocalCart();
            }
        }

        function calculateCartTotals(currentCart) {
            let totalItems = 0;
            let totalPrice = 0;
            currentCart.forEach(item => {
                totalItems += item.quantity;
                totalPrice += item.quantity * item.price;
            });
            return { totalItems, totalPrice };
        }

        function updateLocalCart() {
            renderCartModal(cart);
            renderMobileCartFloat(calculateCartTotals(cart));
        }


        // --- Group Order Functions ---

        async function createGroupOrder() {
            if (!db || !isAuthReady) {
                return showModal('æç¤º', 'è³‡æ–™åº«å°šæœªé€£ç·šï¼Œè«‹ç¨å€™å†è©¦ã€‚');
            }
            if (!userId || userId === 'anonymous') {
                return showModal('æç¤º', 'ä½¿ç”¨è€…èªè­‰æœªå®Œæˆï¼Œè«‹ç¨å€™ã€‚');
            }
            if (!currentShopId) {
                 return showModal('æç¤º', 'è«‹å…ˆé¸æ“‡ä¸€å€‹åº—å®¶å†ç™¼èµ·åœ˜è³¼ã€‚');
            }

            try {
                const docRef = await addDoc(collection(db, GROUP_ORDERS_COLLECTION_PATH), {
                    creatorId: userId,
                    createdAt: new Date(),
                    participants: [userId],
                    shopId: currentShopId, // IMPORTANT: Store the shop ID
                    shopName: shops.find(s => s.id === currentShopId)?.name || 'æœªçŸ¥åº—å®¶',
                    items: [], // [{itemId, quantity, userId, name, price}]
                    status: 'pending'
                });
                await enterGroupOrder(docRef.id, true);
                await showModal('åœ˜è³¼å·²ç™¼èµ·', `æ‚¨å·²æˆåŠŸç™¼èµ·åœ˜è³¼ (åº—å®¶: ${shops.find(s => s.id === currentShopId)?.name})ã€‚ç¾åœ¨å¯ä»¥é»æ“Šã€Œåˆ†äº«æ­¤åœ˜è³¼é€£çµã€æŒ‰éˆ•é‚€è«‹æœ‹å‹åŠ å…¥ã€‚`, 'ç¢ºå®š');
            } catch (e) {
                console.error("Error creating group order:", e);
                await showModal('éŒ¯èª¤', `ç„¡æ³•å‰µå»ºåœ˜è³¼å–®ã€‚éŒ¯èª¤åŸå› : ${e.message}`);
            }
        }

        async function enterGroupOrder(groupId, isCreator = false) {
            if (!db || !isAuthReady) return;

            const groupDocRef = doc(db, GROUP_ORDERS_COLLECTION_PATH, groupId);
            const groupDoc = await getDoc(groupDocRef);

            if (!groupDoc.exists()) {
                exitGroupOrder();
                return showModal('éŒ¯èª¤', 'ç„¡æ³•åŠ å…¥æ­¤åœ˜è³¼å–®ï¼Œå¯èƒ½åœ˜è³¼å·²çµæŸæˆ– ID ç„¡æ•ˆã€‚');
            }

            const groupData = groupDoc.data();

            // Set the shop ID based on the group order
            currentShopId = groupData.shopId;
            updateMenuListener(currentShopId); // Load the menu for the group's shop

            currentGroupOrderId = groupId;
            isGroupOrderCreator = isCreator;
            window.location.hash = `group/${groupId}`; // Update URL hash

            // Ensure the user is added to the participant list on join
            try {
                 await updateDoc(groupDocRef, {
                    participants: arrayUnion(userId)
                });
            } catch (e) {
                console.error("Error adding user to group participants:", e);
            }

            listenToGroupOrder(groupId);
            setMode('customer'); // Always switch to customer mode
        }

        function exitGroupOrder() {
            currentGroupOrderId = null;
            isGroupOrderCreator = false;
            cart = []; // Clear local cart
            window.location.hash = ''; // Clear URL hash
            // Reload the menu for the default/previously selected shop
            if (currentShopId) {
                updateMenuListener(currentShopId);
            }
            setMode('customer'); // Reset to customer mode
        }

        function listenToGroupOrder(groupId) {
             const groupDocRef = doc(db, GROUP_ORDERS_COLLECTION_PATH, groupId);
             onSnapshot(groupDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Set group shop name in header
                    document.getElementById('groupShopName').textContent = data.shopName || 'æœªçŸ¥åº—å®¶';

                    // If the group order's shop ID changes (unlikely) or is different from local, update.
                    if (currentShopId !== data.shopId) {
                        currentShopId = data.shopId;
                        updateMenuListener(currentShopId);
                    }

                    // Update local cart with merged items from all participants
                    cart = data.items || [];
                    renderCartModal(cart, data.participants, data.creatorId);

                    // Show the order button only to the creator
                    const checkoutBtn = document.getElementById('checkoutBtn');
                    if (userId === data.creatorId) {
                        checkoutBtn.textContent = 'ä¸‹åœ˜è³¼è¨‚å–®';
                        checkoutBtn.classList.remove('hidden');
                        isGroupOrderCreator = true;
                    } else {
                        checkoutBtn.textContent = 'ç­‰å¾…ç™¼èµ·äººä¸‹å–®...';
                        checkoutBtn.classList.add('hidden'); // Only creator can checkout
                        isGroupOrderCreator = false;
                    }

                    // Show group header and hide selector
                    document.getElementById('groupHeader').classList.remove('hidden');
                    shopSelector.disabled = true;

                } else {
                    console.log("Group order not found, exiting group mode.");
                    exitGroupOrder();
                }
            }, (error) => {
                console.error("Error listening to group order:", error);
            });
        }

        async function updateGroupOrderItem(itemId, quantityChange, itemDetails = null) {
            if (!currentGroupOrderId || !db) return;

            const groupDocRef = doc(db, GROUP_ORDERS_COLLECTION_PATH, currentGroupOrderId);

            await runTransaction(db, async (transaction) => {
                const groupDoc = await transaction.get(groupDocRef);
                if (!groupDoc.exists()) {
                    throw "Group Order does not exist!";
                }

                const groupData = groupDoc.data();
                let items = groupData.items || [];
                // Find existing item by both itemId and userId
                const existingIndex = items.findIndex(i => i.itemId === itemId && i.userId === userId);

                if (existingIndex !== -1) {
                    // Item already in cart, update quantity
                    items[existingIndex].quantity += quantityChange;
                    if (items[existingIndex].quantity <= 0) {
                        items.splice(existingIndex, 1); // Remove item if quantity is zero
                    }
                } else if (quantityChange > 0 && itemDetails) {
                    // New item: add to cart (only if quantityChange is positive)
                    items.push({
                        itemId: itemId,
                        quantity: quantityChange,
                        userId: userId,
                        name: itemDetails.name,
                        price: itemDetails.price
                        // Shop details are stored on the group order itself
                    });
                }

                transaction.update(groupDocRef, { items: items });
            });
        }

        async function submitOrder() {
            if (cart.length === 0) {
                return await showModal('éŒ¯èª¤', 'è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼');
            }

            const totals = calculateCartTotals(cart);
            const confirm = await showModal('ç¢ºèªè¨‚å–®', `æ‚¨ç¢ºå®šè¦æäº¤é€™ ${totals.totalItems} å€‹é …ç›®çš„è¨‚å–®å—ï¼Ÿç¸½é‡‘é¡ NT$ ${totals.totalPrice}`, 'ç¢ºå®šä¸‹å–®', 'å–æ¶ˆ');
            if (!confirm) return;

            try {
                // If in group order mode, submit the whole group order and clear it
                if (currentGroupOrderId) {
                    if (!isGroupOrderCreator) {
                        return await showModal('æ¬Šé™éŒ¯èª¤', 'åªæœ‰åœ˜è³¼ç™¼èµ·äººå¯ä»¥ä¸‹æœ€çµ‚è¨‚å–®ã€‚');
                    }
                    const groupDocRef = doc(db, GROUP_ORDERS_COLLECTION_PATH, currentGroupOrderId);
                    const groupDoc = await getDoc(groupDocRef);
                    const groupData = groupDoc.data();

                    // Create final merged order for history
                    await addDoc(collection(db, ORDERS_COLLECTION_PATH), {
                        userId: groupData.creatorId,
                        isGroup: true,
                        participants: groupData.participants,
                        items: groupData.items, // Already consolidated
                        shopId: groupData.shopId,
                        shopName: groupData.shopName,
                        totalPrice: calculateCartTotals(groupData.items).totalPrice,
                        timestamp: new Date(),
                        status: 'å¾…è™•ç†'
                    });

                    // Delete the group order document to end the session
                    await deleteDoc(groupDocRef);
                    await showModal('åœ˜è³¼è¨‚å–®æˆåŠŸ', 'åœ˜è³¼è¨‚å–®å·²æˆåŠŸé€å‡ºï¼');
                    exitGroupOrder(); // Exit group mode after successful submission

                } else {
                    // Personal Order
                    await addDoc(collection(db, ORDERS_COLLECTION_PATH), {
                        userId: userId,
                        isGroup: false,
                        items: cart,
                        shopId: currentShopId,
                        shopName: shops.find(s => s.id === currentShopId)?.name || 'æœªçŸ¥åº—å®¶',
                        totalPrice: totals.totalPrice,
                        timestamp: new Date(),
                        status: 'å¾…è™•ç†'
                    });
                    await showModal('è¨‚å–®æˆåŠŸ', 'æ‚¨çš„è¨‚å–®å·²æˆåŠŸé€å‡ºï¼');
                    cart = []; // Clear local cart
                    updateLocalCart();
                }

            } catch (e) {
                console.error("Error submitting order:", e);
                await showModal('éŒ¯èª¤', `ä¸‹å–®å¤±æ•—: ${e.message}`);
            }
        }


        // --- Render Functions ---

        function renderUI() {
            renderShopSelector(); // Ensure shop selector reflects current state
            if (isCustomerMode) {
                renderMenuList();
                updateLocalCart();
            } else {
                renderAdminShopList();
                if (currentAdminShopId) {
                    renderAdminMenu();
                }
            }
        }

        function renderShopSelector() {
            // Customer Shop Selector
            shopSelector.innerHTML = '';
            const currentShop = shops.find(s => s.id === currentShopId);

            if (shops.length === 0) {
                 shopSelector.insertAdjacentHTML('beforeend', `<option value="">ç„¡å¯ç”¨åº—å®¶</option>`);
                 shopSelector.disabled = true;
                 startGroupOrderBtn.disabled = true;
            } else {
                shops.forEach(shop => {
                    const selected = shop.id === currentShopId ? 'selected' : '';
                    shopSelector.insertAdjacentHTML('beforeend', `<option value="${shop.id}" ${selected}>${shop.name}</option>`);
                });
                 shopSelector.disabled = currentGroupOrderId !== null;
                 startGroupOrderBtn.disabled = false;
                 startGroupOrderBtn.innerHTML = '<i class="ph ph-users-three text-lg mr-2"></i> ç™¼èµ·åœ˜è³¼';
            }
        }

        function renderMenuList() {
            const container = document.getElementById('menuList');
            container.innerHTML = '';
            document.getElementById('loadingMenuMessage').classList.add('hidden');

            if (menuItems.length === 0) {
                document.getElementById('emptyMenuMessage').classList.remove('hidden');
                return;
            } else {
                document.getElementById('emptyMenuMessage').classList.add('hidden');
            }

            menuItems.forEach(item => {
                const itemHtml = `
                    <div class="bg-white p-4 rounded-xl shadow-lg flex items-center space-x-4 hover:shadow-xl transition-shadow duration-300 transform hover:scale-[1.01] cursor-pointer">
                        <div class="flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border border-gray-200">
                            <img src="${item.imageUrl || 'https://placehold.co/150x150/e0f2fe/0369a1?text=å•†å“'}" alt="${item.name}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/150x150/e0f2fe/0369a1?text=å•†å“'">
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-gray-800">${item.name} <span class="text-xs text-gray-400">(${item.category})</span></h3>
                            <p class="text-sm text-gray-500">${item.description}</p>
                            <p class="text-xl font-bold text-red-500 mt-1">NT$ ${item.price}</p>
                        </div>
                        <button onclick="addToCart('${item.id}')" class="flex-shrink-0 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-full shadow-md transition-colors duration-200 transform hover:scale-105">
                            <i class="ph ph-plus text-lg"></i>
                        </button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', itemHtml);
            });
        }

        function renderAdminShopList() {
             const container = document.getElementById('shopListContainer');
             container.innerHTML = '';
             document.getElementById('noShopsMessage').classList.toggle('hidden', shops.length > 0);

             shops.forEach(shop => {
                const isCurrent = shop.id === currentAdminShopId;
                 const shopHtml = `
                    <div class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center border ${isCurrent ? 'border-blue-500 ring-2 ring-blue-200' : 'border-gray-200'}">
                        <p class="font-semibold text-gray-800">${shop.name} ${isCurrent ? '(ç·¨è¼¯ä¸­)' : ''}</p>
                        <div class="flex space-x-2">
                            <button onclick="selectAdminShop('${shop.id}')" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-md transition-colors duration-200">
                                ${isCurrent ? 'å–æ¶ˆç·¨è¼¯' : 'ç·¨è¼¯èœå–®'}
                            </button>
                            <button onclick="deleteShop('${shop.id}')" class="bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-1 px-3 rounded-md transition-colors duration-200">åˆªé™¤åº—å®¶</button>
                        </div>
                    </div>
                 `;
                 container.insertAdjacentHTML('beforeend', shopHtml);
             });
        }

        function renderAdminMenu() {
            const container = document.getElementById('menuItemsContainer');
            container.innerHTML = '';
            document.getElementById('noMenuItemsMessage').classList.toggle('hidden', menuItems.length > 0);

            if (!currentAdminShopId) {
                document.getElementById('shopMenuManagement').classList.add('hidden');
                return;
            }

            const currentShop = shops.find(s => s.id === currentAdminShopId);
            document.getElementById('currentAdminShopName').textContent = currentShop ? currentShop.name : 'æœªçŸ¥åº—å®¶';
            document.getElementById('shopMenuManagement').classList.remove('hidden');

            menuItems.forEach(item => {
                const itemHtml = `
                    <div class="bg-gray-50 p-4 rounded-lg shadow-md flex justify-between items-center border">
                        <div>
                            <p class="font-semibold text-gray-800">${item.name} (${item.category})</p>
                            <p class="text-sm text-red-500">NT$ ${item.price}</p>
                            <p class="text-xs text-gray-500 truncate max-w-xs">åœ–ç‰‡: ${item.imageUrl || 'ç„¡'}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editMenuItem('${item.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-semibold py-1 px-3 rounded-md transition-colors duration-200">ç·¨è¼¯</button>
                            <button onclick="deleteMenuItem('${item.id}')" class="bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-1 px-3 rounded-md transition-colors duration-200">åˆªé™¤</button>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', itemHtml);
            });
        }

        function renderCartModal(currentCart, participants = [], creatorId = null) {
            const list = document.getElementById('cartItemsList');
            list.innerHTML = '';
            const totals = calculateCartTotals(currentCart);

            if (currentCart.length === 0) {
                document.getElementById('emptyCartMessage').classList.remove('hidden');
            } else {
                document.getElementById('emptyCartMessage').classList.add('hidden');
                currentCart.forEach(item => {
                    const isCurrentUserItem = item.userId === userId;
                    const itemHtml = `
                        <div class="flex items-center justify-between p-3 border-b last:border-b-0">
                            <div>
                                <h4 class="font-semibold text-gray-800">${item.name}</h4>
                                <p class="text-xs text-gray-500">NT$ ${item.price} ${currentGroupOrderId ? (isCurrentUserItem ? '(æˆ‘çš„)' : '(åœ˜å“¡)') : ''}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="removeFromCart('${item.itemId}')" ${currentGroupOrderId && !isCurrentUserItem ? 'disabled' : ''} class="text-red-500 hover:text-red-700 disabled:opacity-50 transition-colors duration-200">
                                    <i class="ph ph-minus-circle text-xl"></i>
                                </button>
                                <span class="font-bold text-lg w-6 text-center">${item.quantity}</span>
                                <button onclick="addToCart('${item.itemId}')" ${currentGroupOrderId && !isCurrentUserItem ? 'disabled' : ''} class="text-blue-500 hover:text-blue-700 disabled:opacity-50 transition-colors duration-200">
                                    <i class="ph ph-plus-circle text-xl"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    list.insertAdjacentHTML('beforeend', itemHtml);
                });
            }

            document.getElementById('finalTotalPrice').textContent = `NT$ ${totals.totalPrice}`;
            document.getElementById('checkoutBtn').onclick = submitOrder;

            // Group Order Specific UI
            const groupParticipantsDiv = document.getElementById('groupParticipants');
            const participantList = document.getElementById('participantList');

            if (currentGroupOrderId) {
                groupParticipantsDiv.classList.remove('hidden');
                participantList.innerHTML = participants.map(pId =>
                    `<span class="px-2 py-1 rounded-full text-xs font-medium ${pId === creatorId ? 'bg-yellow-300 text-yellow-900' : 'bg-gray-200 text-gray-700'}">${pId} ${pId === creatorId ? '(ç™¼èµ·äºº)' : ''}</span>`
                ).join('');

                const checkoutBtn = document.getElementById('checkoutBtn');
                if (!isGroupOrderCreator) {
                     checkoutBtn.classList.add('hidden'); // Hide for non-creators
                } else {
                     checkoutBtn.classList.remove('hidden');
                }

            } else {
                groupParticipantsDiv.classList.add('hidden');
                document.getElementById('checkoutBtn').classList.remove('hidden'); // Show for personal
                document.getElementById('checkoutBtn').textContent = 'ä¸‹è¨‚å–®';
            }
        }

        function renderMobileCartFloat(totals) {
            document.getElementById('mobileItemCount').textContent = totals.totalItems;
            document.getElementById('mobileTotalPrice').textContent = `NT$ ${totals.totalPrice}`;
        }

        function renderOrderHistory(orders) {
            const list = document.getElementById('orderHistoryList');
            list.innerHTML = '';
            document.getElementById('noOrdersMessage').classList.toggle('hidden', orders.length > 0);

            orders.forEach(order => {
                const statusColor = order.status === 'å¾…è™•ç†' ? 'bg-red-100 text-red-800' :
                                    order.status === 'æº–å‚™ä¸­' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-green-100 text-green-800';
                const itemsSummary = order.items.map(i => `${i.name} x${i.quantity}`).join(', ');

                const orderHtml = `
                    <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-gray-800 text-sm">${order.timestamp.toDate().toLocaleTimeString()}</span>
                            <span class="text-xs font-medium px-2 py-0.5 rounded-full ${statusColor}">${order.status}</span>
                        </div>
                        <p class="text-gray-600 text-sm truncate">åº—å®¶: ${order.shopName || 'æœªçŸ¥'}</p>
                        <p class="text-gray-600 text-sm truncate">${itemsSummary}</p>
                        ${order.isGroup ? `<p class="text-xs text-indigo-500">åœ˜è³¼è¨‚å–® (å…± ${order.participants.length} äºº)</p>` : ''}
                        <p class="text-lg font-bold text-red-600 mt-1">ç¸½é‡‘é¡: NT$ ${order.totalPrice}</p>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', orderHtml);
            });
        }


        // --- Admin Shop Actions ---

        document.getElementById('addNewShopBtn').addEventListener('click', async () => {
            const shopName = await showModal('æ–°å¢åº—å®¶', 'è«‹è¼¸å…¥æ–°åº—å®¶çš„åç¨±:', 'ç¢ºå®šæ–°å¢', 'å–æ¶ˆ', 'text');
            if (shopName === false || shopName === null || shopName.trim() === '') return;

            try {
                await addDoc(collection(db, SHOPS_COLLECTION_PATH), {
                    name: shopName.trim(),
                    createdAt: new Date()
                });
                await showModal('æˆåŠŸ', `åº—å®¶ ${shopName} å·²æ–°å¢ï¼`);
            } catch (e) {
                console.error("Error adding shop:", e);
                await showModal('éŒ¯èª¤', 'æ–°å¢åº—å®¶å¤±æ•—ã€‚');
            }
        });

        async function deleteShop(shopId) {
            const shop = shops.find(s => s.id === shopId);
            const confirm = await showModal('ç¢ºèªåˆªé™¤åº—å®¶', `æ‚¨ç¢ºå®šè¦åˆªé™¤åº—å®¶ "${shop.name}" åŠå…¶æ‰€æœ‰èœå–®é …ç›®å—ï¼Ÿ`, 'ç¢ºå®šåˆªé™¤', 'å–æ¶ˆ');
            if (!confirm) return;

            try {
                // To delete a subcollection, you must delete all documents within it first.
                // We will only delete the main shop document here for simplicity, relying on security rules for safety.
                // Note: The menu items in the subcollection will become orphaned if not manually deleted.

                await deleteDoc(doc(db, SHOPS_COLLECTION_PATH, shopId));
                if (shopId === currentAdminShopId) {
                    currentAdminShopId = null;
                    document.getElementById('shopMenuManagement').classList.add('hidden');
                }
                if (shopId === currentShopId) {
                    currentShopId = null;
                }
                await showModal('æˆåŠŸ', `åº—å®¶ ${shop.name} å·²åˆªé™¤ã€‚`);
            } catch (e) {
                console.error("Error deleting shop:", e);
                await showModal('éŒ¯èª¤', 'åˆªé™¤åº—å®¶å¤±æ•—ã€‚');
            }
        }

        async function selectAdminShop(shopId) {
            if (currentAdminShopId === shopId) {
                // Deselect
                currentAdminShopId = null;
                document.getElementById('shopMenuManagement').classList.add('hidden');
                if (menuUnsubscribe) {
                    menuUnsubscribe();
                    menuItems = [];
                }
            } else {
                // Select and listen to its menu
                currentAdminShopId = shopId;
                updateMenuListener(shopId); // Reuse the same listener logic
            }
            renderUI(); // Re-render admin shop list to highlight selected one
        }


        // --- Admin Menu Actions ---

        document.getElementById('modeToggleBtn').addEventListener('click', async () => {
            if (isCustomerMode) {
                const key = await showModal('ç®¡ç†å“¡ç™»å…¥', 'è«‹è¼¸å…¥ç®¡ç†å“¡å¯†é‘°:', 'ç™»å…¥', 'å–æ¶ˆ', 'password');
                if (key === ADMIN_KEY) {
                    setMode('admin');
                } else if (key !== false && key !== null) {
                    await showModal('éŒ¯èª¤', 'å¯†é‘°éŒ¯èª¤ã€‚');
                }
            } else {
                setMode('customer');
            }
        });

        document.getElementById('addNewItemBtn').addEventListener('click', async () => {
            if (!currentAdminShopId) {
                return showModal('æç¤º', 'è«‹å…ˆåœ¨ä¸Šæ–¹é¸æ“‡ä¸€å€‹åº—å®¶ç·¨è¼¯èœå–®ã€‚');
            }
            const item = { name: '', price: 0, category: 'ä¸»é£Ÿ', description: '', imageUrl: '' };
            await openItemEditor(item, true);
        });

        async function openItemEditor(item, isNew = false) {
            const shopId = currentAdminShopId || item.shopId;
            if (!shopId) return showModal('éŒ¯èª¤', 'æœªé¸æ“‡åº—å®¶ã€‚');

            const name = await showModal('ç·¨è¼¯åç¨±', 'è«‹è¼¸å…¥å•†å“åç¨±', 'ä¸‹ä¸€æ­¥', 'å–æ¶ˆ', 'text', item.name);
            if (name === false || name === null) return;
            item.name = name;

            const priceStr = await showModal('ç·¨è¼¯åƒ¹æ ¼', 'è«‹è¼¸å…¥å•†å“åƒ¹æ ¼ (æ•¸å­—)', 'ä¸‹ä¸€æ­¥', 'å–æ¶ˆ', 'text', item.price.toString());
            if (priceStr === false || priceStr === null) return;
            item.price = parseInt(priceStr);

            const category = await showModal('ç·¨è¼¯é¡åˆ¥', 'è«‹è¼¸å…¥å•†å“é¡åˆ¥ (å¦‚ï¼šä¸»é£Ÿ, é£²æ–™)', 'ä¸‹ä¸€æ­¥', 'å–æ¶ˆ', 'text', item.category);
            if (category === false || category === null) return;
            item.category = category;

            const description = await showModal('ç·¨è¼¯æè¿°', 'è«‹è¼¸å…¥å•†å“æè¿°', 'ä¸‹ä¸€æ­¥', 'å–æ¶ˆ', 'text', item.description);
            if (description === false || description === null) return;
            item.description = description;

            const imageUrl = await showModal('åœ–ç‰‡ URL', 'è«‹è²¼ä¸Šå•†å“åœ–ç‰‡çš„ç¶²è·¯é€£çµ (å¯ç•™ç©º)', 'å„²å­˜', 'å–æ¶ˆ', 'text', item.imageUrl);
            if (imageUrl === false || imageUrl === null) return;
            item.imageUrl = imageUrl || 'https://placehold.co/150x150/e0f2fe/0369a1?text=å•†å“';

            const menuCollectionRef = collection(db, `${SHOPS_COLLECTION_PATH}/${shopId}/menu`);

            try {
                if (isNew) {
                    await addDoc(menuCollectionRef, { ...item, createdAt: new Date() });
                } else {
                    await updateDoc(doc(menuCollectionRef, item.id), item);
                }
                await showModal('æˆåŠŸ', 'èœå–®å·²æ›´æ–°ï¼');
            } catch (e) {
                 console.error("Error updating menu item:", e);
                 await showModal('éŒ¯èª¤', 'èœå–®æ›´æ–°å¤±æ•—ã€‚');
            }
        }

        async function editMenuItem(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            await openItemEditor(item, false);
        }

        async function deleteMenuItem(itemId) {
            if (!currentAdminShopId) return;

            const confirm = await showModal('ç¢ºèªåˆªé™¤', 'æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹èœå–®é …ç›®å—ï¼Ÿ', 'ç¢ºå®šåˆªé™¤', 'å–æ¶ˆ');
            if (!confirm) return;

            const menuCollectionRef = collection(db, `${SHOPS_COLLECTION_PATH}/${currentAdminShopId}/menu`);
            try {
                await deleteDoc(doc(menuCollectionRef, itemId));
                await showModal('æˆåŠŸ', 'èœå–®é …ç›®å·²åˆªé™¤ã€‚');
            } catch (e) {
                console.error("Error deleting document:", e);
                await showModal('éŒ¯èª¤', 'åˆªé™¤å¤±æ•—ã€‚');
            }
        }

        // --- AI Menu Generation Logic ---

        document.getElementById('generateMenuBtn').addEventListener('click', async () => {
            if (!currentAdminShopId) {
                return showModal('æç¤º', 'è«‹å…ˆé¸æ“‡ä¸€å€‹åº—å®¶ã€‚');
            }
            const menuText = document.getElementById('menuInput').value.trim();
            if (!menuText) {
                return showModal('æç¤º', 'è«‹åœ¨æ–‡å­—æ¡†ä¸­è²¼ä¸Šæ‚¨çš„èœå–®å…§å®¹ã€‚');
            }

            document.getElementById('aiLoading').classList.remove('hidden');
            document.getElementById('aiPreviewContainer').classList.add('hidden');

            try {
                const parsedItems = await parseMenuText(menuText);
                if (parsedItems && parsedItems.length > 0) {
                    aiGeneratedItems = parsedItems;
                    renderAIPreview();
                } else {
                    await showModal('æç¤º', 'AI ç„¡æ³•å¾æ‚¨çš„æ–‡æœ¬ä¸­è§£æå‡ºæœ‰æ•ˆçš„èœå–®é …ç›®ã€‚');
                }
            } catch (error) {
                console.error("AI generation failed:", error);
                await showModal('éŒ¯èª¤', 'AI ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è¼¸å…¥æ ¼å¼ã€‚');
            } finally {
                document.getElementById('aiLoading').classList.add('hidden');
            }
        });

        async function parseMenuText(text) {
            const systemPrompt = "ä½ æ˜¯ä¸€å€‹èœå–®è§£æåŠ©æ‰‹ã€‚è«‹å°‡ç”¨æˆ¶æä¾›çš„éçµæ§‹åŒ–èœå–®æ–‡æœ¬è½‰æ›ç‚ºçµæ§‹åŒ–çš„ JSON é™£åˆ—ã€‚å¿½ç•¥æ‰€æœ‰ä¸ç›¸é—œçš„æ–‡æœ¬ã€‚åƒ¹æ ¼å¿…é ˆæ˜¯ç´”æ•¸å­—ã€‚é¡åˆ¥æ˜¯ç°¡çŸ­çš„ä¸­æ–‡å–®è© (ä¾‹å¦‚ï¼šä¸»é£Ÿ, é£²æ–™, å°èœ)ã€‚æè¿°å¦‚æœä¸å­˜åœ¨å‰‡ç•™ç©ºã€‚";
            const userQuery = `è«‹è§£æä»¥ä¸‹èœå–®æ–‡æœ¬ä¸¦è¼¸å‡º JSONï¼š\n\n${text}`;
            const apiKey = "" // If you want to use models other than gemini-2.5-flash-preview-09-2025 or imagen-4.0-generate-001, provide an API key here. Otherwise, leave this as-is.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "name": { "type": "STRING", description: "å•†å“åç¨±" },
                                "price": { "type": "NUMBER", description: "å•†å“åƒ¹æ ¼ (ç´”æ•¸å­—)" },
                                "category": { "type": "STRING", description: "å•†å“é¡åˆ¥" },
                                "description": { "type": "STRING", description: "å•†å“æè¿°" },
                            },
                            required: ["name", "price", "category"]
                        }
                    }
                }
            };

            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (jsonText) {
                try {
                    return JSON.parse(jsonText);
                } catch (e) {
                    console.error("Failed to parse AI JSON:", e, jsonText);
                    return null;
                }
            }
            return null;
        }

        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                } catch (error) {
                    // Do not log error on retry
                }
                if (i < retries - 1) {
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); // Exponential backoff
                }
            }
            throw new Error('API request failed after multiple retries.');
        }

        function renderAIPreview() {
            const container = document.getElementById('aiPreviewList');
            container.innerHTML = '';

            aiGeneratedItems.forEach((item, index) => {
                const itemHtml = `
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <p class="font-semibold text-gray-800">${index + 1}. ${item.name} <span class="text-red-600 font-bold">NT$ ${item.price}</span></p>
                        <p class="text-sm text-gray-600">é¡åˆ¥: ${item.category} | æè¿°: ${item.description || 'ç„¡'}</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', itemHtml);
            });
            document.getElementById('aiPreviewContainer').classList.remove('hidden');
        }

        document.getElementById('saveAllAIToMenuBtn').addEventListener('click', async () => {
            if (!currentAdminShopId) {
                return showModal('æç¤º', 'è«‹å…ˆé¸æ“‡ä¸€å€‹åº—å®¶ã€‚');
            }
            if (aiGeneratedItems.length === 0) {
                return showModal('æç¤º', 'æ²’æœ‰å¯ä»¥å„²å­˜çš„ AI é …ç›®ã€‚');
            }

            const confirm = await showModal('ç¢ºèªæ‰¹é‡å„²å­˜', `ç¢ºå®šè¦å°‡é€™ ${aiGeneratedItems.length} å€‹ AI ç”Ÿæˆçš„é …ç›®åŠ å…¥èœå–®å—ï¼Ÿ`, 'ç¢ºå®šå„²å­˜', 'å–æ¶ˆ');
            if (!confirm) return;

            const menuCollectionRef = collection(db, `${SHOPS_COLLECTION_PATH}/${currentAdminShopId}/menu`);
            const batch = aiGeneratedItems.map(item => {
                return addDoc(menuCollectionRef, {
                    ...item,
                    price: parseInt(item.price), // Ensure price is number
                    imageUrl: item.imageUrl || 'https://placehold.co/150x150/e0f2fe/0369a1?text=å•†å“',
                    createdAt: new Date()
                });
            });

            try {
                await Promise.all(batch);
                aiGeneratedItems = [];
                document.getElementById('aiPreviewContainer').classList.add('hidden');
                document.getElementById('menuInput').value = '';
                await showModal('æˆåŠŸ', 'æ‰€æœ‰ AI èœå–®é …ç›®å·²æˆåŠŸåŠ å…¥ã€‚');
            } catch (e) {
                console.error("Error saving AI items:", e);
                await showModal('éŒ¯èª¤', 'æ‰¹é‡å„²å­˜å¤±æ•—ã€‚');
            }
        });

        // --- UI Interactions ---

        function showCartModal() {
            document.getElementById('cartModal').classList.remove('hidden');
            document.getElementById('cartPanel').classList.remove('translate-y-full');
            document.getElementById('cartPanel').classList.add('translate-y-0');
        }

        function hideCartModal() {
            document.getElementById('cartPanel').classList.add('translate-y-full');
            document.getElementById('cartPanel').classList.remove('translate-y-0');
            setTimeout(() => {
                document.getElementById('cartModal').classList.add('hidden');
            }, 300); // Wait for transition to finish
        }

        document.getElementById('openCartBtnMobile').addEventListener('click', showCartModal);
        document.getElementById('startGroupOrderBtn').addEventListener('click', createGroupOrder);

        document.getElementById('copyGroupLinkBtn').addEventListener('click', async () => {
            const url = window.location.href;
            try {
                // Use execCommand for broader compatibility in iFrames
                const tempInput = document.createElement('input');
                tempInput.value = url;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                await showModal('æˆåŠŸ', 'åœ˜è³¼é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            } catch (err) {
                await showModal('éŒ¯èª¤', 'ç„¡æ³•è¤‡è£½é€£çµï¼Œè«‹æ‰‹å‹•è¤‡è£½åœ°å€æ¬„çš„ URLã€‚');
            }
        });

        // Expose functions to global scope for HTML event handlers
        window.addToCart = addToCart;
        window.removeFromCart = removeFromCart;
        window.editMenuItem = editMenuItem;
        window.deleteMenuItem = deleteMenuItem;
        window.hideCartModal = hideCartModal;
        window.submitOrder = submitOrder;
        window.deleteShop = deleteShop;
        window.selectAdminShop = selectAdminShop;

        // --- Initial Load ---
        window.onload = function() {
            createManifest(); // Initialize PWA manifest
            firebaseInit(); // Initialize Firebase and Auth
        };
    </script>
</body>
</html>
